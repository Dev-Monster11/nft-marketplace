version: "3"

networks:
  app_proxy:
  #  name: ${COMPOSE_NET}
  db_net:
  

volumes:
  caddy_data: {}
  app_data:
    name: ${COMPOSE_VOLUME}
  db_data:

services:
  caddy:
    container_name: marketplace_proxy
    image: lucaslorentz/caddy-docker-proxy:${CADDY_PROXY_VERSION?err}
    ports:
      - 80:80
      - 443:443
    networks:
      - app_proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - caddy_data:/data
    deploy:
      labels:
        caddy.email: ${LETSENCRYPT_EMAIL?err}
      placement:
        constraints:
          - node.role == manager
      replicas: 1
      restart_policy:
        condition: any # unless-stopped # use any for docker-compose version < 2
      resources:
        reservations:
          cpus: "0.1"
          memory: 200M

  marketplace-app:
    build:
      context: ./app/.
      dockerfile: Dockerfile.${SOL_NET}
      args:
        #NODE_ENV: ${NODE_ENV}
        NODE_VERSION: ${NODE_VERSION}
        NEXT_BASE_PATH: ${NEXT_BASE_PATH}
        NEXT_PUBLIC_SOLANA_NETWORK: ${NEXT_PUBLIC_SOLANA_NETWORK}
        NEXT_PUBLIC_SOLANA_RPC_HOST: ${NEXT_PUBLIC_SOLANA_RPC_HOST}
        NEXT_PUBLIC_GOOGLE_ANALYTICS_ID: ${NEXT_PUBLIC_GOOGLE_ANALYTICS_ID}
        NEXT_PUBLIC_STORE_ADDRESS: ${NEXT_PUBLIC_STORE_ADDRESS}
        NEXT_ENABLE_NFT_PACKS: ${NEXT_ENABLE_NFT_PACKS}
        NEXT_SPL_TOKEN_MINTS: ${NEXT_SPL_TOKEN_MINTS}
        NEXT_CG_SPL_TOKEN_IDS: ${NEXT_CG_SPL_TOKEN_IDS}

    container_name: ${COMPOSE_HOSTNAME}
    user: "node:node"
    restart: unless-stopped
    networks:
      - app_proxy
    ports:
      - "${COMPOSE_PORT}:${NEXT_PORT}"
    volumes:
      - "app_data:/app:rw"
    command: ${COMPOSE_COMMAND}
    working_dir: /app
    env_file:
      - ${ENV_FILE}
    labels:
      caddy: ${WEBSITE_HOSTNAME?err}
      caddy.reverse_proxy: "{{upstreams http ${NEXT_PORT}}}"
       # caddy.tls: "${CADDY_TLS}"
      caddy.tls.ca: "https://acme-v02.api.letsencrypt.org/directory" #"https://acme-staging-v02.api.letsencrypt.org/directory"
      caddy.@ws.0_header: Connection *Upgrade*
      caddy.@ws.1_header: Upgrade websocket

  backend-app:
    depends_on:
      - mongodatabase
    build: 
      context: ./backend/.
      dockerfile: Dockerfile.${SOL_NET}
    restart: unless-stopped
    networks:
      - app_proxy
    ports:
      - 8080:8080
    environment:
      - DB_HOST=mongodb
      - DB_USER=${MONGODB_USER}
      - DB_PASSWORD=${MONGODB_PASSWORD}
      - DB_NAME=${MONGODB_DATABASE}
      - DB_PORT=${MONGODB_DOCKER_PORT}
    stdin_open: true
    tty: true

  mongodatabase:
   image: mongo:5.0.2
   restart: unless-stopped
   environment:
    - MONGO_INITDB_ROOT_USERNAME=${MONGODB_USER}
    - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_PASSWORD}
#   ports:
#     - 27018:27017
   volumes:
     - db_data:/data/db